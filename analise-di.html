<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Expertzy Intelig√™ncia Tribut√°ria">
    <meta name="description" content="Sistema de c√°lculo de custos de importa√ß√£o - Processamento de DI (Declara√ß√£o de Importa√ß√£o)">
    <title>Importa√ß√£o DI - Expertzy Intelig√™ncia Tribut√°ria</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/expertzy-brand.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/invoice-sketch.css">
    <link rel="stylesheet" href="assets/css/expertzy-brand.css">
    <link rel="stylesheet" href="assets/css/layout.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="assets/css/modules.css">
    <link rel="stylesheet" href="assets/css/pricing.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="assets/icons/favicon.svg">
    
    <!-- Preload fonts for performance -->
    <link rel="preload" href="assets/fonts/gadeg-thin.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="assets/fonts/brfirma-medium.woff2" as="font" type="font/woff2" crossorigin>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div>
                    <h1 class="app-title">
                        <span class="title-icon">üìä</span>
                        <div>
                            Importa√ß√£o DI
                            <div class="app-subtitle">Sistema de C√°lculo de Custos</div>
                        </div>
                    </h1>
                </div>
                <div class="header-actions">
                    <div class="expertzy-logo">
                        <img src="images/logo-expertzy.png" alt="Expertzy Intelig√™ncia Tribut√°ria" height="50">
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="app-main">
            <!-- Upload Section -->
            <section class="upload-section">
                <div class="expertzy-card">
                    <div class="expertzy-card-header">
                        <h2 class="expertzy-card-title">üìÅ Importar Arquivo XML da DI</h2>
                    </div>
                    
                    <div class="drag-drop-zone" id="dragDropZone">
                        <span class="drag-drop-icon">üìÑ</span>
                        <div class="drag-drop-text">Arraste seu arquivo XML aqui</div>
                        <div class="drag-drop-hint">ou clique para selecionar</div>
                        <input type="file" id="fileInput" class="file-input-hidden" accept=".xml" />
                    </div>
                    
                    <div id="fileInfo" class="expertzy-hidden">
                        <div class="status-indicator success">
                            <span class="status-icon">‚úì</span>
                            <span id="fileName">Arquivo selecionado</span>
                        </div>
                        <div class="progress-container expertzy-hidden" id="progressContainer">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                            </div>
                            <div class="progress-text" id="progressText">Processando...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Configuration Section -->
            <section class="config-section expertzy-hidden" id="configSection">
                <div class="config-panel">
                    <h3 class="config-title">
                        ‚öôÔ∏è Configura√ß√£o de Custos (INCOTERM)
                    </h3>
                    
                    <div id="incotermDetected" class="expertzy-hidden">
                        <div class="incoterm-indicator detected">
                            <span>üéØ</span>
                            <span id="detectedIncotermText">INCOTERM detectado: FOB</span>
                        </div>
                        <br>
                    </div>
                    
                    <div class="config-options">
                        <label class="config-option">
                            <input type="checkbox" id="freteEmbutido" class="expertzy-checkbox">
                            <span>
                                Frete embutido no VCMV
                                <small class="config-hint">Marque se INCOTERM for CFR ou CIF</small>
                            </span>
                        </label>
                        
                        <label class="config-option">
                            <input type="checkbox" id="seguroEmbutido" class="expertzy-checkbox">
                            <span>
                                Seguro embutido no VCMV
                                <small class="config-hint">Marque se INCOTERM for CIF</small>
                            </span>
                        </label>
                    </div>

                    <!-- Configura√ß√£o ICMS e CFOP -->
                    <div class="config-section-divider">
                        <h4 class="config-subsection-title">
                            üí∞ Configura√ß√£o de ICMS e CFOP
                        </h4>
                    </div>
                    
                    <div class="config-options">
                        <div class="config-option">
                            <label for="estadoDestino">Estado de destino (UF):</label>
                            <select id="estadoDestino" class="expertzy-select">
                                <option value="">Selecionar estado...</option>
                                <option value="AC">Acre (AC)</option>
                                <option value="AL">Alagoas (AL)</option>
                                <option value="AP">Amap√° (AP)</option>
                                <option value="AM">Amazonas (AM)</option>
                                <option value="BA">Bahia (BA)</option>
                                <option value="CE">Cear√° (CE)</option>
                                <option value="DF">Distrito Federal (DF)</option>
                                <option value="ES">Esp√≠rito Santo (ES)</option>
                                <option value="GO" selected>Goi√°s (GO)</option>
                                <option value="MA">Maranh√£o (MA)</option>
                                <option value="MT">Mato Grosso (MT)</option>
                                <option value="MS">Mato Grosso do Sul (MS)</option>
                                <option value="MG">Minas Gerais (MG)</option>
                                <option value="PA">Par√° (PA)</option>
                                <option value="PB">Para√≠ba (PB)</option>
                                <option value="PR">Paran√° (PR)</option>
                                <option value="PE">Pernambuco (PE)</option>
                                <option value="PI">Piau√≠ (PI)</option>
                                <option value="RJ">Rio de Janeiro (RJ)</option>
                                <option value="RN">Rio Grande do Norte (RN)</option>
                                <option value="RS">Rio Grande do Sul (RS)</option>
                                <option value="RO">Rond√¥nia (RO)</option>
                                <option value="RR">Roraima (RR)</option>
                                <option value="SC">Santa Catarina (SC)</option>
                                <option value="SP">S√£o Paulo (SP)</option>
                                <option value="SE">Sergipe (SE)</option>
                                <option value="TO">Tocantins (TO)</option>
                            </select>
                        </div>
                        
                        <div class="config-option">
                            <label for="aliquotaICMSPadrao">Al√≠quota ICMS padr√£o (%):</label>
                            <input type="number" id="aliquotaICMSPadrao" class="expertzy-input" 
                                   value="19" min="0" max="100" step="0.01" 
                                   placeholder="19.00">
                            <small class="config-hint">Ser√° aplicada a todas as adi√ß√µes inicialmente</small>
                        </div>

                        <div class="config-option">
                            <label for="cfopPadrao">CFOP padr√£o:</label>
                            <select id="cfopPadrao" class="expertzy-select">
                                <option value="">Selecionar CFOP...</option>
                                <option value="3101">3101 - Compra para industrializa√ß√£o</option>
                                <option value="3102" selected>3102 - Compra para comercializa√ß√£o</option>
                                <option value="3126">3126 - Compra para utiliza√ß√£o na presta√ß√£o de servi√ßo</option>
                                <option value="3127">3127 - Compra para ativo imobilizado</option>
                                <option value="3128">3128 - Compra para consumo</option>
                                <option value="3129">3129 - Compra para material de uso ou consumo</option>
                                <option value="3132">3132 - Aquisi√ß√£o de servi√ßo de transporte</option>
                                <option value="3251">3251 - Compra de energia el√©trica para distribui√ß√£o ou comercializa√ß√£o</option>
                                <option value="3301">3301 - Aquisi√ß√£o de servi√ßo de comunica√ß√£o</option>
                            </select>
                            <small class="config-hint">Ser√° aplicado a todas as adi√ß√µes inicialmente</small>
                        </div>
                    </div>
                    
                    <div class="expertzy-flex expertzy-justify-center">
                        <button class="expertzy-btn expertzy-btn-primary" id="processBtn" disabled>
                            <span>üíæ</span>
                            Processar e Calcular Custos
                        </button>
                    </div>
                </div>
            </section>

            <!-- Results Section -->
            <section class="results-section expertzy-hidden" id="resultsSection">
                <!-- Summary Cards -->
                <div class="results-summary" id="resultsSummary">
                    <div class="summary-card">
                        <div class="summary-label">Total de Adi√ß√µes</div>
                        <div class="summary-value" id="totalAdicoes">0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Total de Itens</div>
                        <div class="summary-value" id="totalItens">0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Valor FOB</div>
                        <div class="summary-value" id="valorFOB">R$ 0,00</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Custo Total</div>
                        <div class="summary-value" id="custoTotal">R$ 0,00</div>
                    </div>
                </div>

                <!-- Validation Results -->
                <div class="validation-section" id="validationSection">
                    <div class="validation-header">
                        <h3 class="validation-title">
                            üîç Valida√ß√£o dos C√°lculos
                        </h3>
                    </div>
                    <div class="validation-results" id="validationResults">
                        <!-- Validation items will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Results Table -->
                <div class="results-container" id="resultsContainer">
                    <div class="results-header">
                        <h3 class="results-title">üìã Resultados Detalhados</h3>
                        <div class="results-actions">
                            <button class="expertzy-btn expertzy-btn-outline" id="expandAllBtn">
                                Expandir Todas
                            </button>
                            <button class="expertzy-btn expertzy-btn-outline" id="collapseAllBtn">
                                Contrair Todas
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="expertzy-table" id="resultsTable">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>Adi√ß√£o</th>
                                        <th>NCM</th>
                                        <th>Descri√ß√£o</th>
                                        <th>INCOTERM</th>
                                        <th>CFOP</th>
                                        <th>ICMS %</th>
                                        <th>VCMV R$</th>
                                        <th>Custo Total R$</th>
                                        <th>II R$</th>
                                        <th>% Participa√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTableBody">
                                    <!-- Table rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Export Section -->
            <section class="export-section expertzy-hidden" id="exportSection">
                <div class="export-actions">
                    <button class="export-btn" id="exportExcelBtn" disabled>
                        <span class="export-icon">üìä</span>
                        <span class="export-label">Excel Completo</span>
                        <span class="export-description">Relat√≥rio multi-aba com todos os detalhes</span>
                    </button>
                    
                    <button class="export-btn" id="exportCSVBtn" disabled>
                        <span class="export-icon">üìÑ</span>
                        <span class="export-label">CSV Resumo</span>
                        <span class="export-description">Dados para importa√ß√£o em ERP</span>
                    </button>
                    
                    <button class="export-btn" id="exportPDFBtn" disabled>
                        <span class="export-icon">üìã</span>
                        <span class="export-label">Relat√≥rio PDF</span>
                        <span class="export-description">Resumo executivo formatado</span>
                    </button>
                    
                    <button class="export-btn" id="pricingBtn" disabled>
                        <span class="export-icon">üí∞</span>
                        <span class="export-label">M√≥dulo de Precifica√ß√£o</span>
                        <span class="export-description">C√°lculo de pre√ßos de venda com an√°lise tribut√°ria</span>
                    </button>
                    
                    <button class="export-btn" id="invoiceSketchBtn" disabled>
                        <span class="export-icon">üìÑ</span>
                        <span class="export-label">Croqui da NF</span>
                        <span class="export-description">Gera√ß√£o de croqui da nota fiscal de entrada</span>
                    </button>
                    
                    <button class="export-btn" id="saveConfigBtn" disabled>
                        <span class="export-icon">üíæ</span>
                        <span class="export-label">Salvar Dados</span>
                        <span class="export-description">Hist√≥rico local para compara√ß√µes</span>
                    </button>
                </div>
            </section>

            <!-- Error Container -->
            <div class="error-container expertzy-hidden" id="errorContainer">
                <div class="error-title">
                    <span>‚ö†Ô∏è</span>
                    Erro no Processamento
                </div>
                <div class="error-message" id="errorMessage">
                    Ocorreu um erro durante o processamento do arquivo.
                </div>
                <details>
                    <summary>Detalhes t√©cnicos</summary>
                    <div class="error-details" id="errorDetails">
                        <!-- Error details will be populated by JavaScript -->
                    </div>
                </details>
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState">
                <div class="empty-icon">üìÅ</div>
                <h3 class="empty-title">Pronto para processar sua DI</h3>
                <p class="empty-description">
                    Fa√ßa upload do arquivo XML da Declara√ß√£o de Importa√ß√£o para come√ßar o c√°lculo 
                    autom√°tico de custos unit√°rios com distribui√ß√£o proporcional de impostos e despesas.
                </p>
            </div>
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <p>¬© 2025 Expertzy Intelig√™ncia Tribut√°ria</p>
        </footer>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer">
        <!-- Toast notifications will be inserted here by JavaScript -->
    </div>

    <!-- Pricing Modal -->
    <div class="modal-overlay" id="pricingModal" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h3>üí∞ M√≥dulo de Precifica√ß√£o</h3>
                <button class="modal-close" id="closePricingModal">&times;</button>
            </div>
            <div class="modal-body" id="pricingContent">
                <!-- Pricing content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Bibliotecas Externas (locais) -->
    <script src="assets/js/libs/xlsx.full.min.js"></script>
    <script src="assets/js/libs/jspdf.min.js"></script>
    <script src="assets/js/libs/jspdf-autotable.min.js"></script>
    
    <!-- Sistema Modular Expertzy DI -->
    <script src="assets/js/app.js"></script>
    
    <!-- M√≥dulos Utilit√°rios -->
    <script src="assets/js/utils/dom-utils.js"></script>
    <script src="assets/js/utils/file-utils.js"></script>
    <script src="assets/js/utils/data-utils.js"></script>
    <script src="assets/js/utils/audit-logger.js"></script>
    
    <!-- M√≥dulos Principais -->
    <script src="assets/js/modules/xml-processor.js"></script>
    <script src="assets/js/modules/cost-calculator.js"></script>
    <script src="assets/js/modules/incentives.js"></script>
    <script src="assets/js/modules/validation.js"></script>
    <script src="assets/js/modules/pricing.js"></script>
    <script src="assets/js/modules/pricing-ui.js"></script>
    <script src="assets/js/modules/reports.js"></script>
    
    <!-- Scripts Legados (compatibilidade) -->
    <script src="legacy/js/importa-di-complete.js"></script>
    <script src="legacy/js/pricing-module.js"></script>
    <script src="legacy/js/professional-reports.js"></script>
    <script src="legacy/js/invoiceSketch.js"></script>
    
    <!-- Inicializa√ß√£o do Sistema -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar sistema modular
            if (window.ExpertzyDI) {
                ExpertzyDI.init();
                ExpertzyDI.modules.pricingUI.init();
                ExpertzyDI.log('SYSTEM', 'Sistema Expertzy DI inicializado com sucesso');
                
                // Integra√ß√£o com sistema legado
                integrarSistemaPrecificacao();
            }
        });
        
        // Fun√ß√£o para integrar m√≥dulo de precifica√ß√£o com sistema legado
        function integrarSistemaPrecificacao() {
            // Observar mudan√ßas na se√ß√£o de resultados
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    const resultsSection = document.getElementById('resultsSection');
                    if (resultsSection && !resultsSection.classList.contains('expertzy-hidden')) {
                        // Resultados foram exibidos - mostrar m√≥dulo de precifica√ß√£o
                        setTimeout(function() {
                            if (window.ExpertzyDI && window.ExpertzyDI.modules.pricingUI) {
                                ExpertzyDI.modules.pricingUI.mostrar();
                                
                                // Tentar sincronizar dados se dispon√≠veis
                                sincronizarDadosPrecificacao();
                            }
                        }, 1000);
                    }
                });
            });
            
            // Observar mudan√ßas no DOM
            observer.observe(document.body, {
                childList: true,
                subtree: true,
                attributes: true,
                attributeFilter: ['class', 'style']
            });
        }
        
        // Sincronizar dados do sistema legado com sistema modular
        function sincronizarDadosPrecificacao() {
            try {
                // Tentar extrair dados dos resultados exibidos
                const custoTotal = extrairCustoTotal();
                const impostosDI = extrairImpostosDI();
                
                if (custoTotal && impostosDI) {
                    // Criar estrutura de dados para o sistema modular
                    const dadosImportacao = {
                        custoUnitario: custoTotal,
                        impostos: impostosDI,
                        dataProcessamento: new Date().toISOString()
                    };
                    
                    // Armazenar no namespace modular
                    if (window.ExpertzyDI) {
                        window.ExpertzyDI.data.currentDI = dadosImportacao;
                        ExpertzyDI.log('INTEGRATION', 'Dados sincronizados com m√≥dulo de precifica√ß√£o', dadosImportacao);
                    }
                }
            } catch (error) {
                console.warn('Erro na sincroniza√ß√£o de dados:', error);
            }
        }
        
        // Extrair custo total dos resultados
        function extrairCustoTotal() {
            const custoElements = document.querySelectorAll('.result-value');
            for (let element of custoElements) {
                const text = element.textContent;
                if (text.includes('R$') && text.includes('Total')) {
                    const valor = text.replace(/[R$,\s]/g, '').replace('.', '');
                    return parseFloat(valor) / 100; // Converter centavos para reais
                }
            }
            return null;
        }
        
        // Extrair impostos da DI dos resultados
        function extrairImpostosDI() {
            const impostos = {};
            
            // Tentar extrair valores de impostos das tabelas de resultados
            const tabelas = document.querySelectorAll('table');
            tabelas.forEach(tabela => {
                const rows = tabela.querySelectorAll('tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 2) {
                        const label = cells[0].textContent.trim();
                        const valor = cells[1].textContent.trim();
                        
                        // Mapear para estrutura esperada
                        if (label.includes('I.I.') || label.includes('Imposto Import')) {
                            impostos.II = { valor: parseFloat(valor.replace(/[R$,\s]/g, '')) / 100 };
                        } else if (label.includes('I.P.I')) {
                            impostos.IPI = { valor: parseFloat(valor.replace(/[R$,\s]/g, '')) / 100 };
                        } else if (label.includes('PIS')) {
                            impostos.PIS = { valor: parseFloat(valor.replace(/[R$,\s]/g, '')) / 100 };
                        } else if (label.includes('COFINS')) {
                            impostos.COFINS = { valor: parseFloat(valor.replace(/[R$,\s]/g, '')) / 100 };
                        } else if (label.includes('ICMS')) {
                            impostos.ICMS = { valor: parseFloat(valor.replace(/[R$,\s]/g, '')) / 100 };
                        }
                    }
                });
            });
            
            return Object.keys(impostos).length > 0 ? impostos : null;
        }
    </script>
</body>
</html>